---
# by default, do not allow ingress and egress from/to everywhere
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  labels:
    deploymentSet: infra-network-policies
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress

---
# egress policy allow cluster access
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-cluster-egress
  labels:
    deploymentSet: infra-network-policies
spec:
  podSelector: 
    matchLabels:
      egress-type: cluster
  egress:
  # allows access to application namespace
  - to:
    - namespaceSelector:
        matchLabels:
          name: bookinfo
  # allow cluster dns
  - ports:
    - port: 1053
      protocol: UDP
    - port: 1053
      protocol: TCP
    - port: 53
      protocol: UDP
    - port: 53
      protocol: TCP
    to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
      podSelector:
        matchLabels:
          k8s-app: kube-dns
  # allow access to opentracing
  - to:
    - namespaceSelector:
        matchLabels:
          name: opentracing

---
# egress policy that allows internet access except azure metadata service
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-internet-access
  labels:
    deploymentSet: infra-network-policies
spec:
  podSelector: 
    matchLabels:
      egress-type: internet
  policyTypes:
  - Egress
  egress:
  # allow access to internet except azure metadata service
  - to:
    - ipBlock:
        cidr: 0.0.0.0/0
        except:
        - 169.254.169.254/32
  # allows access to application namespace
  - to:
    - namespaceSelector:
        matchLabels:
          name: bookinfo
  # allow cluster dns
  - ports:
    - port: 1053
      protocol: UDP
    - port: 1053
      protocol: TCP
    - port: 53
      protocol: UDP
    - port: 53
      protocol: TCP
    to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
      podSelector:
        matchLabels:
          k8s-app: kube-dns
  # allow access to opentracing
  - to:
    - namespaceSelector:
        matchLabels:
          name: opentracing

---
# by default, allow access from the metrics namespace for prometheus
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-allow-ingress-from-prometheus-g8s
  labels:
    deploymentSet: infra-network-policies
spec:
  podSelector: {}
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: prometheus
---
# by default, allow access from the linkerd namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-allow-ingress-from-linkerd
  labels:
    deploymentSet: infra-network-policies
spec:
  podSelector:
    matchLabels:
      "linkerd.io/control-plane-ns": "linkerd"
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          "linkerd.io/is-control-plane": "true"
